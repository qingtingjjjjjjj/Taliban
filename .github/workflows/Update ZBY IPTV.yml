name: Update ZBY IPTV

on:
  schedule:
    - cron: '0 2 * * *'   # æ¯å¤©åŒ—äº¬æ—¶é—´ 10:00 è¿è¡Œï¼ˆUTC+8ï¼‰
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Fetch fixed IPTV source and update zby.txt
      run: |
        FIXED_API="https://raw.githubusercontent.com/xiaolin330328/ctv/refs/heads/main/ç¬¬äºŒ"
        ZBY_FILE="zby.txt"

        # è¯»å–åŸæ–‡ä»¶å†…å®¹
        if [ -f "$ZBY_FILE" ]; then
          ORIGINAL_CONTENT=$(cat "$ZBY_FILE")
        else
          ORIGINAL_CONTENT=""
        fi

        # æ‹‰å–å›ºå®šæ¥å£å†…å®¹
        API_CONTENT=$(curl -s --max-time 20 "$FIXED_API")
        if [ -z "$API_CONTENT" ]; then
          echo "âš  å›ºå®šæ¥å£æŠ“å–å¤±è´¥"
          exit 1
        fi

        # æ‹¼æ¥æ–°å¢éƒ¨åˆ†
        NEW_CONTENT="\n\n# ===== æ–°å¢ç›´æ’­æº =====\n\n$API_CONTENT"

        # å»æ‰æ—§çš„æ–°å¢éƒ¨åˆ†
        if grep -q "# ===== æ–°å¢ç›´æ’­æº =====" "$ZBY_FILE"; then
          ORIGINAL_CONTENT=$(sed '/# ===== æ–°å¢ç›´æ’­æº =====/,$d' "$ZBY_FILE")
        fi

        # å†™å›æ–‡ä»¶
        echo -e "${ORIGINAL_CONTENT}${NEW_CONTENT}" > "$ZBY_FILE"
        echo "âœ… zby.txt å·²æ›´æ–°"

    - name: Commit and push changes
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git add zby.txt
        git commit -m "ğŸ“¡ è‡ªåŠ¨æ›´æ–°å›ºå®šæ¥å£ç›´æ’­æº" || echo "No changes to commit"
        git push
