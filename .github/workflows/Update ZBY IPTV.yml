name: Update ZBY IPTV

on:
  schedule:
    - cron: '0 2 * * *'   # 每天北京时间 10:00 运行（UTC+8）
  workflow_dispatch:       # 支持手动触发

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Fetch fixed IPTV source and update zby.txt
      run: |
        FIXED_API="https://raw.githubusercontent.com/xiaolin330328/ctv/refs/heads/main/第二"
        ZBY_FILE="zby.txt"

        # 读取原文件内容
        if [ -f "$ZBY_FILE" ]; then
          ORIGINAL_CONTENT=$(cat "$ZBY_FILE")
        else
          ORIGINAL_CONTENT=""
        fi

        # 拉取固定接口内容
        API_CONTENT=$(curl -s --max-time 20 "$FIXED_API")
        if [ -z "$API_CONTENT" ]; then
          echo "⚠ 固定接口抓取失败"
          exit 1
        fi

        # 拼接新增部分
        NEW_CONTENT="\n\n# ===== 新增直播源 =====\n\n$API_CONTENT"

        # 去掉旧的新增部分
        if grep -q "# ===== 新增直播源 =====" "$ZBY_FILE"; then
          ORIGINAL_CONTENT=$(sed '/# ===== 新增直播源 =====/,$d' "$ZBY_FILE")
        fi

        # 写回文件
        echo -e "${ORIGINAL_CONTENT}${NEW_CONTENT}" > "$ZBY_FILE"
        echo "✅ zby.txt 已更新"

    - name: Commit and push changes
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git add zby.txt
        git commit -m "📡 自动更新固定接口直播源" || echo "No changes to commit"
        git push
